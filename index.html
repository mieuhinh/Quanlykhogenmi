<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Kho 4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { padding-bottom: 90px; background-color: #f3f4f6; font-family: sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: center; }
    </style>
</head>
<body>

    <div class="bg-indigo-800 text-white p-4 sticky top-0 flex justify-between items-center shadow-md z-50">
        <h1 id="page-title" class="font-bold">QU·∫¢N L√ù KHO</h1>
        <button onclick="fetchData()" class="p-2 bg-indigo-600 rounded-full">üîÑ</button>
    </div>

    <div id="content" class="p-4"></div>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around p-2 shadow-lg z-50 text-gray-500">
        <button onclick="renderHome()" class="flex flex-col items-center">üè†<span class="text-[10px]">Home</span></button>
        <button onclick="renderForm('Nh·∫≠p')" class="flex flex-col items-center text-green-600">‚ûï<span class="text-[10px]">Nh·∫≠p</span></button>
        <button onclick="renderForm('Xu·∫•t')" class="flex flex-col items-center text-red-600">‚ûñ<span class="text-[10px]">Xu·∫•t</span></button>
        <button onclick="renderReportPeriod()" class="flex flex-col items-center text-indigo-600">üìä<span class="text-[10px]">B√°o c√°o</span></button>
        <button onclick="renderSettings()" class="flex flex-col items-center">‚öôÔ∏è<span class="text-[10px]">C√†i ƒë·∫∑t</span></button>
    </nav>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwqj90HCbwjd43F3bxTWgq5QQB1WVlPb6nOsfMqsrLKCevTCYva3h_Ky8lI9f0_TvbY7A/exec"; 
        let rawData = { transactions: [], products: [], warehouses: [] };

        async function fetchData() {
            document.getElementById('content').innerHTML = "<p class='text-center mt-10 text-gray-400 animate-pulse'>ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</p>";
            const res = await fetch(SCRIPT_URL);
            rawData = await res.json();
            renderHome();
        }

        function renderHome() {
            document.getElementById('page-title').innerText = "Trang Ch·ªß";
            document.getElementById('content').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="card p-6 text-center border-b-4 border-indigo-500">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Giao d·ªãch</p>
                        <h2 class="text-3xl font-black">${rawData.transactions.length}</h2>
                    </div>
                    <div class="card p-6 text-center border-b-4 border-orange-500">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">S·∫£n ph·∫©m</p>
                        <h2 class="text-3xl font-black">${rawData.products.length}</h2>
                    </div>
                </div>
            `;
        }

        // --- H√ÄM QU·∫¢N L√ù DANH M·ª§C (TH√äM/X√ìA) ---
        function renderSettings() {
            document.getElementById('page-title').innerText = "Thi·∫øt L·∫≠p Danh M·ª•c";
            document.getElementById('content').innerHTML = `
                <div class="space-y-6">
                    ${renderCategorySection("S·∫£n Ph·∫©m", "DanhMucSP", rawData.products)}
                    ${renderCategorySection("Kho H√†ng", "DanhMucKho", rawData.warehouses)}
                </div>
            `;
        }

        function renderCategorySection(label, type, list) {
            let listHtml = list.map(item => `
                <div class="flex justify-between items-center p-3 border-b bg-white last:border-0">
                    <span class="font-medium text-gray-700">${item}</span>
                    <button onclick="manageCategory('${type}', 'delete', '${item}')" class="text-red-500 text-xs font-bold px-3 py-1 bg-red-50 rounded-lg">X√ìA</button>
                </div>
            `).join('');

            return `
                <div class="card">
                    <div class="p-4 bg-gray-50 font-bold text-sm border-b">${label.toUpperCase()}</div>
                    <div class="p-4 flex gap-2">
                        <input id="input-${type}" type="text" placeholder="Th√™m m·ªõi..." class="flex-1 border p-2 rounded-lg outline-none focus:ring-1 ring-indigo-500">
                        <button onclick="manageCategory('${type}', 'add')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold">+</button>
                    </div>
                    <div class="max-h-60 overflow-y-auto">${listHtml || '<p class="p-4 text-gray-400 text-center">Tr·ªëng</p>'}</div>
                </div>
            `;
        }

        async function manageCategory(type, method, value) {
            if (method === 'add') {
                value = document.getElementById(`input-${type}`).value.trim();
                if (!value) return;
            }
            if (method === 'delete' && !confirm(`X√≥a "${value}" kh·ªèi danh m·ª•c?`)) return;

            const payload = { action: "manage_category", type, method, value };
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            fetchData(); // T·∫£i l·∫°i d·ªØ li·ªáu
        }

        // --- GI·ªÆ NGUY√äN C√ÅC H√ÄM NH·∫¨P XU·∫§T V√Ä B√ÅO C√ÅO T·ª™ B·∫¢N TR∆Ø·ªöC ---
        function renderForm(type) {
            document.getElementById('page-title').innerText = "Phi·∫øu " + type;
            let whOptions = rawData.warehouses.map(k => `<option value="${k}">${k}</option>`).join('');
            let pDatalist = `<datalist id="pList">${rawData.products.map(p => `<option value="${p}">`).join('')}</datalist>`;

            document.getElementById('content').innerHTML = `
                ${pDatalist}
                <div class="card p-4 mb-4 border-l-8 ${type==='Nh·∫≠p'?'border-green-500':'border-red-500'}">
                    <label class="text-[10px] font-bold text-gray-400 italic">S·ªê PHI·∫æU / CH·ª®NG T·ª™</label>
                    <input id="soPhieu" type="text" placeholder="VD: PN001" class="w-full border-b-2 py-2 mb-4 outline-none focus:border-indigo-500">
                    <label class="text-[10px] font-bold text-gray-400">CH·ªåN KHO H√ÄNG</label>
                    <select id="kho" class="w-full bg-gray-50 p-3 rounded-lg mt-1 outline-none shadow-inner">${whOptions}</select>
                </div>
                <div class="card p-4 mb-4">
                    <input id="maSP" list="pList" type="text" placeholder="M√£ s·∫£n ph·∫©m (T·ª± g·ª£i √Ω...)" class="w-full border p-3 mb-3 rounded-lg outline-none focus:ring-2 ring-indigo-200">
                    <input id="soluong" type="number" placeholder="S·ªë l∆∞·ª£ng" class="w-full border p-3 mb-4 rounded-lg outline-none">
                    <button onclick="addItem()" class="w-full py-3 bg-indigo-50 text-indigo-700 rounded-lg font-bold border border-indigo-200 active:bg-indigo-100">+ TH√äM M·∫∂T H√ÄNG</button>
                </div>
                <div id="listDisplay"></div>
                <button id="btnSave" onclick="submitForm('${type}')" class="hidden w-full bg-indigo-700 text-white p-4 rounded-xl font-bold mt-4 shadow-lg active:scale-95 transition uppercase tracking-widest">G·ª≠i Phi·∫øu L√™n Cloud</button>
            `;
        }

        let tempItems = [];
        function addItem() {
            const m = document.getElementById('maSP').value.trim();
            const s = document.getElementById('soluong').value;
            if(!m || !s) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
            tempItems.push({ maSP: m, soluong: Number(s) });
            let h = '<div class="card p-2 bg-gray-50">';
            tempItems.forEach((it, i) => h += `<div class="flex justify-between p-2 border-b text-sm"><span>${i+1}. <b>${it.maSP}</b></span><b>${it.soluong}</b></div>`);
            document.getElementById('listDisplay').innerHTML = h + '</div>';
            document.getElementById('maSP').value = ""; document.getElementById('soluong').value = "";
            document.getElementById('btnSave').classList.remove('hidden');
        }

        async function submitForm(type) {
            const btn = document.getElementById('btnSave');
            btn.innerText = "ƒêANG X·ª¨ L√ù..."; btn.disabled = true;
            const payload = { action: "add_transaction", loai: type, kho: document.getElementById('kho').value, soPhieu: document.getElementById('soPhieu').value || "KSP", items: tempItems };
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("ƒê√£ l∆∞u th√†nh c√¥ng!"); fetchData();
        }

        function renderReportPeriod() {
            document.getElementById('page-title').innerText = "B√°o C√°o T·ªìn Kho";
            const today = new Date().toISOString().split('T')[0];
            let whOptions = `<option value="ALL">T·∫•t c·∫£ kho</option>` + rawData.warehouses.map(k => `<option value="${k}">${k}</option>`).join('');
            document.getElementById('content').innerHTML = `
                <div class="card p-4 mb-4">
                    <select id="filterKho" class="w-full border p-2 mb-3 rounded-lg">${whOptions}</select>
                    <div class="grid grid-cols-2 gap-2 mb-4 text-[10px]">
                        <div>T·ª™ NG√ÄY<input type="date" id="dFrom" value="${today}" class="w-full border p-2 rounded text-base"></div>
                        <div>ƒê·∫æN NG√ÄY<input type="date" id="dTo" value="${today}" class="w-full border p-2 rounded text-base"></div>
                    </div>
                    <button onclick="calculate()" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold">XEM B√ÅO C√ÅO</button>
                </div>
                <div id="reportArea" class="overflow-x-auto rounded-lg bg-white shadow"></div>
            `;
        }

        function calculate() {
    const fWh = document.getElementById('filterKho').value;
    const tF = new Date(document.getElementById('dFrom').value + "T00:00:00");
    const tT = new Date(document.getElementById('dTo').value + "T23:59:59");
    let stats = {};

    rawData.transactions.forEach(r => {
        const date = new Date(r[0]), type = r[1], sku = r[2], qty = Number(r[3]), wh = r[4];
        
        if (fWh !== "ALL" && wh !== fWh) return;

        // CH·ªà L·∫§Y SKU L√ÄM KEY ƒê·ªÇ KH√îNG B·ªä HI·ªÜN T√äN KHO ·ªû C·ªòT 1
        const key = sku; 

        if (!stats[key]) stats[key] = { d: 0, n: 0, x: 0, wh: wh };
        if (date < tF) {
            stats[key].d += (type === "Nh·∫≠p" ? qty : -qty);
        } else if (date <= tT) {
            if (type === "Nh·∫≠p") stats[key].n += qty; 
            else stats[key].x += qty;
        }
    });

    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ b·∫£ng v√† d·ªØ li·ªáu h√†ng
    let h = `<table class="w-full text-xs">
        <thead>
            <tr class="bg-indigo-50">
                <th class="p-2 text-left">M√£ S·∫£n Ph·∫©m</th>
                ${fWh === "ALL" ? '<th class="p-2">Kho</th>' : ''}
                <th class="p-2">ƒê·∫ßu</th>
                <th class="p-2">Nh·∫≠p</th>
                <th class="p-2">Xu·∫•t</th>
                <th class="p-2 bg-indigo-100">Cu·ªëi</th>
            </tr>
        </thead>
        <tbody>`;
    
    for (let k in stats) {
        let s = stats[k]; 
        let c = s.d + s.n - s.x;
        h += `<tr class="border-b">
            <td class="p-3 text-left font-medium text-blue-700">${k}</td>
            ${fWh === "ALL" ? `<td class="p-3 text-gray-500">${s.wh}</td>` : ''}
            <td class="p-3">${s.d}</td>
            <td class="p-3 text-green-600 font-bold">${s.n}</td>
            <td class="p-3 text-red-600 font-bold">${s.x}</td>
            <td class="p-3 font-black text-indigo-700 bg-indigo-50">${c}</td>
        </tr>`;
    }
    document.getElementById('reportArea').innerHTML = h + "</tbody></table>";
}


        fetchData();
    </script>
</body>
</html>
