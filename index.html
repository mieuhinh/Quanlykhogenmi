<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Kho Chuy√™n Nghi·ªáp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { padding-bottom: 90px; background-color: #f8fafc; font-family: sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        th { background: #f1f5f9; }
    </style>
</head>
<body>

    <div class="bg-blue-700 text-white p-4 sticky top-0 shadow-lg flex justify-between items-center">
        <h1 id="page-title" class="font-bold uppercase tracking-wide">Qu·∫£n L√Ω Kho</h1>
        <button onclick="fetchData()" class="bg-blue-500 p-2 rounded-full">üîÑ</button>
    </div>

    <div id="content" class="p-4"></div>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around p-3 shadow-2xl z-50">
        <button onclick="renderHome()" class="text-gray-500 flex flex-col items-center">üè†<span class="text-[10px]">Home</span></button>
        <button onclick="renderForm('Nh·∫≠p')" class="text-gray-500 flex flex-col items-center text-green-600">‚ûï<span class="text-[10px]">Nh·∫≠p</span></button>
        <button onclick="renderForm('Xu·∫•t')" class="text-gray-500 flex flex-col items-center text-red-600">‚ûñ<span class="text-[10px]">Xu·∫•t</span></button>
        <button onclick="renderReportPeriod()" class="text-blue-600 flex flex-col items-center">üìÖ<span class="text-[10px]">B√°o c√°o k·ª≥</span></button>
    </nav>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyHEUP0fyVAb1d3bN_gsGlXvjTaamgC0F6KUSL0iQkYDi2s37EBCVAlC-qwAPNZAnzgHw/exec"; 
        let database = [];
        let tempItems = [];

        async function fetchData() {
            try {
                const res = await fetch(SCRIPT_URL);
                database = await res.json();
                renderHome();
            } catch (e) { alert("L·ªói k·∫øt n·ªëi d·ªØ li·ªáu!"); }
        }

        function renderHome() {
            document.getElementById('page-title').innerText = "Trang Ch·ªß";
            document.getElementById('content').innerHTML = `
                <div class="card p-8 text-center bg-gradient-to-br from-blue-50 to-white border border-blue-100">
                    <p class="text-gray-500 uppercase text-xs font-bold mb-2">T·ªïng s·ªë d√≤ng d·ªØ li·ªáu</p>
                    <h2 class="text-5xl font-black text-blue-700">${database.length}</h2>
                </div>
            `;
        }

        function renderForm(type) {
            tempItems = [];
            document.getElementById('page-title').innerText = "Phi·∫øu " + type;
            document.getElementById('content').innerHTML = `
                <div class="card p-4 mb-4 border-l-4 ${type==='Nh·∫≠p'?'border-green-500':'border-red-500'}">
                    <input id="soPhieu" type="text" placeholder="S·ªë ch·ª©ng t·ª´ (VD: PN001)" class="w-full border p-3 mb-2 rounded-lg">
                    <select id="kho" class="w-full border p-3 mb-2 rounded-lg">
                        <option value="Kho Qu·ªëc Vi·ªát">Kho Qu·ªëc Vi·ªát</option>
                        <option value="Kho Mi·ªÅn Nam">Kho Mi·ªÅn Nam</option>
                    </select>
                </div>
                <div class="card p-4 mb-4">
                    <input id="maSP" type="text" placeholder="M√£ s·∫£n ph·∫©m" class="w-full border p-3 mb-2 rounded-lg">
                    <input id="soluong" type="number" placeholder="S·ªë l∆∞·ª£ng" class="w-full border p-3 mb-2 rounded-lg">
                    <button onclick="addItem()" class="w-full bg-gray-100 text-blue-700 p-3 rounded-lg font-bold border border-blue-200">+ TH√äM M·∫∂T H√ÄNG</button>
                </div>
                <div id="itemList" class="mb-4"></div>
                <button onclick="submitForm('${type}')" id="btnSave" class="hidden w-full bg-blue-700 text-white p-4 rounded-xl font-bold shadow-lg">L∆ØU PHI·∫æU V√ÄO GOOGLE SHEET</button>
            `;
        }

        function addItem() {
            const ma = document.getElementById('maSP').value.trim();
            const sl = document.getElementById('soluong').value;
            if(!ma || !sl) return alert("Nh·∫≠p ƒë·ªß M√£ v√† SL!");
            tempItems.push({ maSP: ma, soluong: Number(sl) });
            let html = '<div class="card p-2 bg-gray-50">';
            tempItems.forEach((item, i) => html += `<div class="p-2 border-b flex justify-between"><span>${i+1}. ${item.maSP}</span><b>${item.soluong}</b></div>`);
            document.getElementById('itemList').innerHTML = html + '</div>';
            document.getElementById('maSP').value = ""; document.getElementById('soluong').value = "";
            document.getElementById('btnSave').classList.remove('hidden');
        }

        async function submitForm(type) {
            const btn = document.getElementById('btnSave');
            btn.innerText = "ƒêANG X·ª¨ L√ù..."; btn.disabled = true;
            const payload = { loai: type, kho: document.getElementById('kho').value, soPhieu: document.getElementById('soPhieu').value, items: tempItems };
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("Th√†nh c√¥ng!"); fetchData();
        }

        function renderReportPeriod() {
            document.getElementById('page-title').innerText = "B√°o C√°o Nh·∫≠p Xu·∫•t T·ªìn";
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('content').innerHTML = `
                <div class="card p-4 mb-4">
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div><label class="text-[10px] font-bold">T·ª™ NG√ÄY</label><input type="date" id="dateFrom" value="${today}" class="w-full border p-2 rounded"></div>
                        <div><label class="text-[10px] font-bold">ƒê·∫æN NG√ÄY</label><input type="date" id="dateTo" value="${today}" class="w-full border p-2 rounded"></div>
                    </div>
                    <button onclick="processPeriodData()" class="w-full bg-blue-600 text-white p-2 rounded font-bold italic">Xem B√°o C√°o</button>
                </div>
                <div id="reportResult" class="table-container"></div>
            `;
        }

        function processPeriodData() {
            const dFrom = new Date(document.getElementById('dateFrom').value + "T00:00:00");
            const dTo = new Date(document.getElementById('dateTo').value + "T23:59:59");
            
            let summary = {}; // Key: "MaSP | Kho"

            database.forEach(row => {
                const rowDate = new Date(row[0]);
                const type = row[1];
                const sku = row[2];
                const qty = Number(row[3]);
                const warehouse = row[4];
                const key = `${sku} [${warehouse}]`;

                if (!summary[key]) summary[key] = { dau: 0, nhap: 0, xuat: 0 };

                if (rowDate < dFrom) {
                    // T√≠nh t·ªìn ƒë·∫ßu
                    summary[key].dau += (type === "Nh·∫≠p" ? qty : -qty);
                } else if (rowDate >= dFrom && rowDate <= dTo) {
                    // T√≠nh ph√°t sinh trong k·ª≥
                    if (type === "Nh·∫≠p") summary[key].nhap += qty;
                    else summary[key].xuat += qty;
                }
            });

            let html = `<table><thead><tr><th>SP [Kho]</th><th>ƒê·∫ßu</th><th>Nh·∫≠p</th><th>Xu·∫•t</th><th>Cu·ªëi</th></tr></thead><tbody>`;
            for (let k in summary) {
                const s = summary[k];
                const cuoi = s.dau + s.nhap - s.xuat;
                html += `<tr>
                    <td class="text-left font-medium">${k}</td>
                    <td class="bg-gray-50">${s.dau}</td>
                    <td class="text-green-600 font-bold">${s.nhap}</td>
                    <td class="text-red-600 font-bold">${s.xuat}</td>
                    <td class="bg-blue-50 font-black">${cuoi}</td>
                </tr>`;
            }
            document.getElementById('reportResult').innerHTML = html + `</tbody></table>`;
        }

        fetchData();
    </script>
</body>
</html>
