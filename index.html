<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Kho Th√¥ng Minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { padding-bottom: 90px; background-color: #f3f4f6; font-family: sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: center; }
        th { background: #f8fafc; font-size: 11px; text-transform: uppercase; color: #64748b; }
    </style>
</head>
<body>

    <div class="bg-indigo-700 text-white p-4 sticky top-0 flex justify-between items-center shadow-md z-50">
        <h1 id="page-title" class="font-bold uppercase tracking-wider">Qu·∫£n L√Ω Kho</h1>
        <button onclick="fetchData()" class="p-2 bg-indigo-500 rounded-full active:scale-90 transition">üîÑ</button>
    </div>

    <div id="content" class="p-4"></div>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around p-3 shadow-lg z-50">
        <button onclick="renderHome()" class="flex flex-col items-center text-gray-500">üè†<span class="text-[10px]">Home</span></button>
        <button onclick="renderForm('Nh·∫≠p')" class="flex flex-col items-center text-green-600 font-bold">‚ûï<span class="text-[10px]">Nh·∫≠p</span></button>
        <button onclick="renderForm('Xu·∫•t')" class="flex flex-col items-center text-red-600 font-bold">‚ûñ<span class="text-[10px]">Xu·∫•t</span></button>
        <button onclick="renderReportPeriod()" class="flex flex-col items-center text-indigo-600">üìä<span class="text-[10px]">B√°o c√°o</span></button>
    </nav>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-LTZh0qp9dsDXbJknH6t_1awlMgX25D9hqinwXJdXpfqcIdIqNEO_UjzAOzA_5pg/exec"; 
        let rawData = { transactions: [], products: [], warehouses: [] };
        let tempItems = [];

        async function fetchData() {
            const content = document.getElementById('content');
            content.innerHTML = "<div class='text-center mt-20'><div class='animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full'></div><p class='mt-2 text-gray-500'>ƒêang ƒë·ªìng b·ªô...</p></div>";
            try {
                const res = await fetch(SCRIPT_URL);
                rawData = await res.json();
                renderHome();
            } catch (e) { content.innerHTML = "<p class='text-red-500 text-center'>L·ªói k·∫øt n·ªëi!</p>"; }
        }

        function renderHome() {
            document.getElementById('page-title').innerText = "Trang Ch·ªß";
            document.getElementById('content').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="card p-6 text-center border-b-4 border-indigo-500">
                        <p class="text-[10px] text-gray-400 font-bold">GIAO D·ªäCH</p>
                        <h2 class="text-3xl font-black text-indigo-700">${rawData.transactions.length}</h2>
                    </div>
                    <div class="card p-6 text-center border-b-4 border-orange-400">
                        <p class="text-[10px] text-gray-400 font-bold">S·∫¢N PH·∫®M</p>
                        <h2 class="text-3xl font-black text-orange-600">${rawData.products.length}</h2>
                    </div>
                </div>
            `;
        }

        function renderForm(type) {
            tempItems = [];
            document.getElementById('page-title').innerText = "Phi·∫øu " + type;
            let whOptions = rawData.warehouses.map(k => `<option value="${k}">${k}</option>`).join('');
            let pDatalist = `<datalist id="pList">${rawData.products.map(p => `<option value="${p}">`).join('')}</datalist>`;

            document.getElementById('content').innerHTML = `
                ${pDatalist}
                <div class="card p-4 mb-4 border-l-8 ${type==='Nh·∫≠p'?'border-green-500':'border-red-500'}">
                    <label class="text-[10px] font-bold text-gray-400">S·ªê CH·ª®NG T·ª™ / M√É PHI·∫æU</label>
                    <input id="soPhieu" type="text" class="w-full border-b-2 py-2 mb-4 outline-none focus:border-indigo-500">
                    <label class="text-[10px] font-bold text-gray-400">CH·ªåN KHO</label>
                    <select id="kho" class="w-full bg-gray-50 p-3 rounded-lg mt-1 outline-none">${whOptions}</select>
                </div>
                <div class="card p-4 mb-4">
                    <input id="maSP" list="pList" type="text" placeholder="M√£ s·∫£n ph·∫©m (G·ª£i √Ω...)" class="w-full border p-3 mb-3 rounded-lg">
                    <input id="soluong" type="number" placeholder="S·ªë l∆∞·ª£ng" class="w-full border p-3 mb-4 rounded-lg">
                    <button onclick="addItem()" class="w-full py-3 bg-indigo-50 text-indigo-700 rounded-lg font-bold border border-indigo-200">+ TH√äM V√ÄO PHI·∫æU</button>
                </div>
                <div id="listDisplay"></div>
                <button id="btnSave" onclick="submitForm('${type}')" class="hidden w-full bg-indigo-700 text-white p-4 rounded-xl font-bold mt-4 shadow-lg active:scale-95 transition">X√ÅC NH·∫¨N L∆ØU</button>
            `;
        }

        function addItem() {
            const m = document.getElementById('maSP').value.trim();
            const s = document.getElementById('soluong').value;
            if(!m || !s) return alert("Thi·∫øu th√¥ng tin!");
            tempItems.push({ maSP: m, soluong: Number(s) });
            let h = '<div class="card p-2 bg-gray-50">';
            tempItems.forEach((it, i) => h += `<div class="flex justify-between p-2 border-b text-sm"><span>${i+1}. ${it.maSP}</span><b>${it.soluong}</b></div>`);
            document.getElementById('listDisplay').innerHTML = h + '</div>';
            document.getElementById('maSP').value = ""; document.getElementById('soluong').value = "";
            document.getElementById('btnSave').classList.remove('hidden');
        }

        async function submitForm(type) {
            const btn = document.getElementById('btnSave');
            btn.innerText = "ƒêANG G·ª¨I..."; btn.disabled = true;
            const payload = { loai: type, kho: document.getElementById('kho').value, soPhieu: document.getElementById('soPhieu').value || "KSP", items: tempItems };
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("ƒê√£ l∆∞u v√†o Google Sheet!"); fetchData();
        }

        function renderReportPeriod() {
            document.getElementById('page-title').innerText = "B√°o C√°o T·ªìn Kho";
            const today = new Date().toISOString().split('T')[0];
            let whOptions = `<option value="ALL">--- T·∫•t c·∫£ c√°c kho ---</option>` + rawData.warehouses.map(k => `<option value="${k}">${k}</option>`).join('');

            document.getElementById('content').innerHTML = `
                <div class="card p-4 mb-4">
                    <label class="text-[10px] font-bold text-gray-400">L·ªåC THEO KHO</label>
                    <select id="filterKho" class="w-full border p-2 mb-3 rounded-lg">${whOptions}</select>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div><label class="text-[10px] font-bold">T·ª™ NG√ÄY</label><input type="date" id="dFrom" value="${today}" class="w-full border p-2 rounded"></div>
                        <div><label class="text-[10px] font-bold">ƒê·∫æN NG√ÄY</label><input type="date" id="dTo" value="${today}" class="w-full border p-2 rounded"></div>
                    </div>
                    <button onclick="calculate()" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold shadow-md active:bg-indigo-800">XEM B√ÅO C√ÅO</button>
                </div>
                <div id="reportArea" class="overflow-x-auto rounded-lg bg-white"></div>
            `;
        }

        function calculate() {
            const fWh = document.getElementById('filterKho').value;
            const tF = new Date(document.getElementById('dFrom').value + "T00:00:00");
            const tT = new Date(document.getElementById('dTo').value + "T23:59:59");
            let stats = {};

            rawData.transactions.forEach(r => {
                const date = new Date(r[0]), type = r[1], sku = r[2], qty = Number(r[3]), wh = r[4];
                
                // L·ªçc theo kho: N·∫øu kh√°c kho ƒëang ch·ªçn (v√† kh√¥ng ph·∫£i ch·ªçn 'ALL') th√¨ b·ªè qua
                if (fWh !== "ALL" && wh !== fWh) return;

                // N·∫øu ch·ªçn 'ALL', gom nh√≥m theo S·∫£n ph·∫©m + Kho. N·∫øu ch·ªçn kho c·ª• th·ªÉ, ch·ªâ gom theo S·∫£n ph·∫©m.
                const key = (fWh === "ALL") ? `${sku} [${wh}]` : sku;

                if (!stats[key]) stats[key] = { d: 0, n: 0, x: 0 };
                if (date < tF) stats[key].d += (type === "Nh·∫≠p" ? qty : -qty);
                else if (date <= tT) {
                    if (type === "Nh·∫≠p") stats[key].n += qty; else stats[key].x += qty;
                }
            });

            let h = `<table class="w-full text-xs"><thead><tr>
                <th class="text-left font-bold text-indigo-700">${fWh === "ALL" ? 'SP [Kho]' : 'M√£ S·∫£n Ph·∫©m'}</th>
                <th>ƒê·∫ßu</th><th>Nh·∫≠p</th><th>Xu·∫•t</th><th class="bg-indigo-50">Cu·ªëi</th>
            </tr></thead><tbody>`;
            
            for (let k in stats) {
                let s = stats[k]; let c = s.d + s.n - s.x;
                h += `<tr class="border-b">
                    <td class="p-3 text-left font-medium">${k}</td>
                    <td class="text-gray-500">${s.d}</td>
                    <td class="text-green-600 font-bold">${s.n}</td>
                    <td class="text-red-600 font-bold">${s.x}</td>
                    <td class="font-black text-indigo-700 bg-indigo-50">${c}</td>
                </tr>`;
            }
            document.getElementById('reportArea').innerHTML = h + "</tbody></table>";
        }

        fetchData();
    </script>
</body>
</html>
